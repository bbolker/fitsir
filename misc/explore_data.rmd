---
title: "Data"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r pkgs}
library(devtools)
load_all("..")
```

## Ebola

I got the data from [here](https://github.com/cmrivers/ebola). [Here](http://currents.plos.org/outbreaks/article/obk-14-0036-early-epidemic-dynamics-of-the-west-african-2014-ebola-outbreak-estimates-derived-with-a-simple-two-parameter-model/)'s a paper that fitted IDEA model to the data.

```{r}
eboladf <- read.csv("country_timeseries.csv")
```

I was going to write a document about examples and fits but I ran into so many problems so I decided to write about errors instead. I'm going to look at Liberia case to demonstrate the problems...

```{r getLiberia}
tmpdf <- eboladf[,c(2,4)]
head(tmpdf)
```

First, I need to reverse the data to put the days in an increasing order:

```{r reverse}
tmpdf <- tmpdf[nrow(tmpdf):1,]
rownames(tmpdf) <- NULL
head(tmpdf)
```

This is probably not a good idea but I'm going to get rid of NA values:

```{r removeNA}
tmpdf <- tmpdf[!is.na(tmpdf[,2]),]
```

This is cumulative incidence data but let's just consider this as prevalence data because working with incidence gives us a lot more problems... 

```{r converting}
df <- setNames(tmpdf, c("tvec", "count"))
t <- df$tvec
```

How well does auto start work?

```{r fitsir}
plot(df)
auto.start <- startfun(auto = TRUE, data = df)
lines(t, SIR.detsim(t, trans.pars(auto.start)))
f1 <- fitsir(df, start = auto.start)
lines(t, SIR.detsim(t, trans.pars(coef(f1))), col = 2)
```

It seems like it's working well.. However, here's a problem with sensitivity fit using nll:

```{r fitsiroptim}
f.ssq <- fitsir.optim(df, start = auto.start)
f.nll <- fitsir.optim(df, start = coef(f.ssq), nll = TRUE)

plot(df)
I.ssq <- SIR.detsim(t, trans.pars(coef(f.ssq)))
I.nll <- SIR.detsim(t, trans.pars(coef(f.nll)))
lines(t, I.ssq)
lines(t, I.nll, col = 2)
```

OK so I fixed this. Now, let's look at the inicidence. We're given cumulative incidence data so we need to convert it.

```{r convert}
tmp.i <- diff(df[,2])
tmp.t <- df[-1,1]
df2 <- data.frame(tvec = tmp.t, count = tmp.i)
plot(df2)
```

We get negative values as well because some people are removed from the counts after going through some tests.

```{r incidence}
(f.i1 <- fitsir(df2, incidence = TRUE))
plot(df2)
tpars <- trans.pars(coef(f.i1))
inc <- SIR.detsim(tmp.t, tpars, incidence = TRUE)
lines(tmp.t, inc)
```

I thought this was bad but now that I think about it, it might not be a problem...?

```{r cuminc}
plot(tmp.t, cumsum(df2$count))
lines(tmp.t, cumsum(inc))
```

```{r}
summarize.pars(coef(f.i1))
```

We know this is a bad parameter...

## Flu (2009) in WSU

I got the data from [here](https://www.researchgate.net/profile/Elissa_Schwartz/publication/266951690_Pandemic_2009_H1N1_influenza_in_two_settings_in_a_small_community_The_workplace_and_the_university_campus/links/55382bfc0cf226723ab616e6.pdf). They use daily reports in other papers but they don't provide it so I'm just going to try with weekly reports to see if it works...

```{r fludata}
df.flu <- data.frame(
    tvec = c(1:16),
    count = c(73, 524, 569, 357, 149, 92, 53, 95, 56, 61, 94, 81, 41, 16, 12, 3))
plot(df.flu)
(fit1 <- fitsir(df.flu, incidence = TRUE))
(fit2 <- fitsir.optim(df.flu, incidence = TRUE, nll = TRUE))
lines(SIR.detsim(df.flu$tvec, trans.pars(coef(fit1)), incidence = TRUE))
lines(SIR.detsim(df.flu$tvec, trans.pars(coef(fit2)), incidence = TRUE), col = 2)

summarize.pars(coef(fit1))
summarize.pars(coef(fit2))
```

Data source says that $N$ is 18234. We don't get any values that are close... It makes sense that we get a bad fit because we're only given reports at every week. Also, they don't provide reportings of the new cases through out the whole week. They just give us new cases that were counted on the day.

## R0 package

This package has some public data: https://github.com/cran/R0

```{r}
library(R0)
data(Germany.1918)
g.inc <- check.incid(Germany.1918)$incid
t.germ <- 1:length(g.inc)
df.1918 <- data.frame(tvec = t.germ, count = g.inc)
(fit.germ1 <- fitsir(df.1918, incidence = TRUE))
(fit.germ2 <- fitsir.optim(df.1918, incidence = TRUE, nll = TRUE))
findSens(df.1918, coef(fit.germ2),plot.it = TRUE, incidence = TRUE, log = "y", nll = TRUE)
```

* This fit doesn't look very good along the tail
* Population size seems pretty bad too
